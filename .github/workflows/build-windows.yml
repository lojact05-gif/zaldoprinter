name: Build Zaldo Printer (Windows)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install Inno Setup
        shell: powershell
        run: |
          choco install innosetup -y
          Write-Host "ISCC (Inno Setup) on PATH:"
          where.exe ISCC
          Write-Host "Default Inno path check:"
          if (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe") { "OK" } else { "NOT FOUND" }

      - name: Run build scripts (fail loud + show outputs)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          Set-Location zaldo_printer/scripts

          Write-Host "=== Running build.ps1 ==="
          powershell -NoProfile -ExecutionPolicy Bypass -File .\build.ps1

          Write-Host "=== Running build_installer.ps1 ==="
          powershell -NoProfile -ExecutionPolicy Bypass -File .\build_installer.ps1

          Write-Host "=== After scripts: list dist/installer/output folders ==="
          Set-Location ../..

          if (Test-Path "zaldo_printer/dist") {
            Write-Host "---- zaldo_printer/dist ----"
            Get-ChildItem -Path "zaldo_printer/dist" -Recurse | Select-Object FullName
          } else {
            Write-Host "NO zaldo_printer/dist folder"
          }

          if (Test-Path "zaldo_printer/installer") {
            Write-Host "---- zaldo_printer/installer ----"
            Get-ChildItem -Path "zaldo_printer/installer" -Recurse | Select-Object FullName
          } else {
            Write-Host "NO zaldo_printer/installer folder"
          }

          Write-Host "---- Searching for any *Setup*.exe ----"
          $found = Get-ChildItem -Path . -Recurse -Filter "*Setup*.exe" -ErrorAction SilentlyContinue
          if ($found) {
            $found | ForEach-Object { Write-Host "FOUND: $($_.FullName)" }
          } else {
            Write-Host "No *Setup*.exe found."
          }

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ZaldoPrinterSetup
          if-no-files-found: error
          path: |
            **/ZaldoPrinterSetup*.exe
            **/*Setup*.exe
